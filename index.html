<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Filter and Remover Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8">
            <div class="flex items-start justify-between">
                <h1 class="text-3xl font-bold mb-6 text-blue-400">Word Filter and Remover Tool</h1>
                <div class="mb-6">
                    <button id="open-settings" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">Settings</button>
                </div>
            </div>

            <!-- Original Text -->
            <div class="mb-6">
                <label for="original-text" class="block text-sm font-medium mb-2 text-gray-300">
                    Original Text
                </label>
                <textarea 
                    id="original-text" 
                    rows="8" 
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none text-gray-100 resize-none"
                    placeholder="Paste your text here..."
                ></textarea>
            </div>

            <!-- Case Sensitive Checkbox -->
            <div class="mb-6 flex items-center">
                <input 
                    type="checkbox" 
                    id="case-sensitive" 
                    class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600 focus:ring-2"
                >
                <label for="case-sensitive" class="ml-2 text-sm font-medium text-gray-300">
                    Case Sensitive
                </label>
            </div>

            <!-- Process Button -->
            <button 
                id="process-button" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 ease-in-out focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 focus:ring-offset-gray-800 mb-6"
            >
                Process & Auto-Copy Text
            </button>

            <!-- Filtered Text Output -->
            <div class="mb-4">
                <label for="filtered-text" class="block text-sm font-medium mb-2 text-gray-300">
                    Filtered Text (Auto-Copied)
                </label>
                <textarea 
                    id="filtered-text" 
                    rows="8" 
                    readonly
                    class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 resize-none cursor-default"
                    placeholder="Filtered text will appear here..."
                ></textarea>
            </div>
        </div>
    </div>

    <!-- Notification Modal (Hidden by default) -->
    <div id="notification-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4 border border-gray-700">
            <h3 class="text-lg font-semibold mb-3 text-red-400">Notice</h3>
            <p id="modal-message" class="text-gray-300 mb-4"></p>
            <button 
                id="modal-close" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200"
            >
                OK
            </button>
        </div>
    </div>

    <!-- Settings Modal (hidden by default) -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 border border-gray-700">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold text-gray-200">Settings</h3>
                <button id="settings-modal-close" class="text-gray-300 hover:text-white">âœ•</button>
            </div>

            <label for="settings-words-to-remove" class="block text-sm font-medium mb-2 text-gray-300">
                Words to Remove (saved to browser, separated by spaces, commas, or newlines)
            </label>
            <textarea
                id="settings-words-to-remove"
                rows="3"
                class="w-full px-3 py-2 mb-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none text-gray-100 resize-none"
                placeholder="Enter words to filter out..."
            ></textarea>

            <label for="settings-filler-words" class="block text-sm font-medium mb-2 text-gray-300">
                Filler Words (will be wrapped in [] when detected, lowercased, no trailing . or ,)
            </label>
            <textarea
                id="settings-filler-words"
                rows="2"
                class="w-full px-3 py-2 mb-4 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none text-gray-100 resize-none"
                placeholder="Enter filler words..."
            ></textarea>

            <div class="flex gap-2">
                <button id="save-settings" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">Save Settings</button>
                <button id="clear-settings" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition">Clear Settings</button>
            </div>
        </div>
    </div>

    <script>
        // Escape special regex characters
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Show notification modal
        function showNotification(message) {
            const modal = document.getElementById('notification-modal');
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        // Hide notification modal
        function hideNotification() {
            const modal = document.getElementById('notification-modal');
            modal.classList.add('hidden');
        }

        // Settings persistence
        function saveSettings() {
            const words = document.getElementById('settings-words-to-remove').value
                .split(/[\s,\n]+/)
                .map(s => s.trim())
                .filter(Boolean);
            const fillers = document.getElementById('settings-filler-words').value
                .split(/[\s,\n]+/)
                .map(s => s.trim())
                .filter(Boolean);

            try {
                localStorage.setItem('wr_words_to_remove', JSON.stringify(words));
                localStorage.setItem('wr_filler_words', JSON.stringify(fillers));
                // give the user feedback and close the modal
                showNotification('Settings saved to localStorage.');
                hideSettingsModal();
            } catch (err) {
                showNotification('Failed to save settings: ' + err.message);
            }
        }

        function loadSettings() {
            try {
                const words = JSON.parse(localStorage.getItem('wr_words_to_remove') || '[]');
                const fillers = JSON.parse(localStorage.getItem('wr_filler_words') || '[]');
                document.getElementById('settings-words-to-remove').value = words.join('\n');
                document.getElementById('settings-filler-words').value = fillers.join('\n');
            } catch (err) {
                console.warn('Failed to load settings:', err);
            }
        }

        function clearSettings() {
            localStorage.removeItem('wr_words_to_remove');
            localStorage.removeItem('wr_filler_words');
            document.getElementById('settings-words-to-remove').value = '';
            document.getElementById('settings-filler-words').value = '';
            showNotification('Settings cleared.');
        }

        // Show/hide settings modal
        function showSettingsModal() {
            const modal = document.getElementById('settings-modal');
            if (modal) modal.classList.remove('hidden');
        }

        function hideSettingsModal() {
            const modal = document.getElementById('settings-modal');
            if (modal) modal.classList.add('hidden');
        }

        // Process text function
        function processText() {
            const wordsToRemoveField = document.getElementById('words-to-remove');
            const originalTextField = document.getElementById('original-text');
            const filteredTextField = document.getElementById('filtered-text');
            const caseSensitiveCheckbox = document.getElementById('case-sensitive');

            // Read words-to-remove from settings (persisted)
            const wordsToRemoveText = document.getElementById('settings-words-to-remove').value;
            const originalText = originalTextField.value;

            // Validation
            if (!originalText.trim()) {
                showNotification('Please paste some text to process.');
                return;
            }

            // Prepare word list: split tokens, trim, and strip surrounding brackets/quotes
            const wordsList = wordsToRemoveText
                .split(/[\s,\n]+/)
                .map(w => w.trim().replace(/^[\[\(\{\<\"']+|[\]\)\}\>\"']+$/g, ''))
                .filter(word => word !== '');

            // Prepare filler words from settings
            const fillerText = document.getElementById('settings-filler-words').value;
            const fillerList = fillerText
                .split(/[\s,\n]+/)
                .map(w => w.trim())
                .filter(Boolean);

            let filteredText = originalText;

            if (wordsList.length > 0) {
                try {
                    // Escape each word and create regex pattern
                    const escapedWords = wordsList.map(word => escapeRegExp(word));
                    const wordAlternation = escapedWords.join('|');

                    // Build patterns that match either the whole word or the word wrapped in any common bracket pair
                    const bracketPatterns = [
                        `\\[\\s*(?:${wordAlternation})\\s*\\]`,
                        `\\(\\s*(?:${wordAlternation})\\s*\\)`,
                        `\\{\\s*(?:${wordAlternation})\\s*\\}`,
                        `<\\s*(?:${wordAlternation})\\s*>`
                    ].join('|');

                    const pattern = `\\b(?:${wordAlternation})\\b|${bracketPatterns}`;

                    // Determine flags based on case sensitivity
                    const flags = caseSensitiveCheckbox.checked ? 'g' : 'gi';
                    const regex = new RegExp(pattern, flags);

                    // Remove matches (this removes bracketed occurrences including their brackets)
                    filteredText = filteredText.replace(regex, '');

                    // Remove any now-empty bracket pairs repeatedly (handles nested/adjacent empty brackets)
                    let prev;
                    let iterations = 0;
                    do {
                        prev = filteredText;
                        filteredText = filteredText
                            .replace(/\[\s*\]/g, '')
                            .replace(/\(\s*\)/g, '')
                            .replace(/\{\s*\}/g, '')
                            .replace(/<\s*>/g, '')
                            .replace(/\s{2,}/g, ' ');
                        iterations++;
                    } while (filteredText !== prev && iterations < 10);
                } catch (error) {
                    showNotification('Regex error: ' + error.message);
                    return;
                }
            }

            // Apply filler-word wrapping: wrap each detected filler word in [] (lowercased, no trailing . or , inside)
            if (fillerList.length > 0) {
                try {
                    // build alternation
                    const escapedFillers = fillerList.map(f => escapeRegExp(f));
                    const fillerPattern = `\\b(${escapedFillers.join('|')})\\b`;
                    const fillerRegex = new RegExp(fillerPattern, caseSensitiveCheckbox.checked ? 'g' : 'gi');

                    filteredText = filteredText.replace(fillerRegex, function(match, p1, offset, string) {
                        // detect punctuation immediately following the match
                        const after = string.slice(offset + match.length, offset + match.length + 1);
                        const trailingPunct = /^[.,]/.test(after) ? after : '';

                        const lowered = match.toLowerCase();
                        // return bracketed lowered word, and move trailing punctuation OUTSIDE the brackets
                        return '[' + lowered.replace(/[.,]+$/g, '') + ']' + (trailingPunct || '');
                    });

                    // remove any stray punctuation inside brackets (just in case)
                    filteredText = filteredText.replace(/\[\s*([^\]\n]*?)\s*[.,]+\s*\]/g, function(m, inner) {
                        return '[' + inner.trim().replace(/[.,]+$/g, '').toLowerCase() + ']';
                    });
                } catch (err) {
                    console.warn('Filler wrap error:', err);
                }
            }

            // Post-removal adjustments for square-bracket content:
            // - Remove any trailing periods (full stops) before the closing ]
            // - Lowercase the first alphabetic character inside the brackets (user requested "small caps"; interpreted as lowercase here)
            filteredText = filteredText.replace(/\[([^\]]*?)\]/g, function(match, inner) {
                // Trim inner spaces on both ends
                let newInner = inner.replace(/^\s+|\s+$/g, '');

                // Remove trailing periods
                newInner = newInner.replace(/\.+$/g, '');

                // Lowercase first alphabetic character (if any)
                newInner = newInner.replace(/^([^\p{L}]*)\p{L}/u, function(m) {
                    // m is whole match; we need to find the first letter and lowercase it
                    return m.slice(0, -1) + m.slice(-1).toLowerCase();
                });

                return '[' + newInner + ']';
            });

            // Post-processing cleanup
            filteredText = filteredText
                .replace(/\s{2,}/g, ' ')                    // Multiple spaces to single space
                .replace(/\s+([.,;?!\]\)\}])/g, '$1')    // Remove space before punctuation/closing brackets/braces
                .replace(/([\[\(\{\<])\s+/g, '$1')      // Remove space after opening brackets/braces
                .trim();                                    // Trim leading/trailing whitespace

            // Set filtered text
            filteredTextField.value = filteredText;

            // Auto-copy to clipboard
            filteredTextField.select();
            try {
                const successful = document.execCommand('copy');
                if (!successful) {
                    showNotification('Copy failed. Please copy manually.');
                }
            } catch (err) {
                showNotification('Copy failed: ' + err.message);
            }

            // Focus the filtered text output (user requested Enter should focus the output)
            filteredTextField.focus();
            filteredTextField.select();
        }

        // Event listeners
        document.getElementById('process-button').addEventListener('click', processText);

        // Settings buttons
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        document.getElementById('clear-settings').addEventListener('click', clearSettings);
        document.getElementById('open-settings').addEventListener('click', function() { loadSettings(); showSettingsModal(); });

        // Modal close buttons
        document.getElementById('modal-close').addEventListener('click', hideNotification);
        document.getElementById('settings-modal-close').addEventListener('click', hideSettingsModal);

        // Enter key handling: when Enter in settings words-to-remove, focus filtered output
        const settingsWordsEl = document.getElementById('settings-words-to-remove');
        if (settingsWordsEl) {
            settingsWordsEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('filtered-text').focus();
                    document.getElementById('filtered-text').select();
                }
            });
        }

        document.getElementById('original-text').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                processText();
            }
        });

        // Click outside modals to close
        document.getElementById('notification-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideNotification();
            }
        });
        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideSettingsModal();
            }
        });

        // Load settings on startup
        loadSettings();
    </script>
</body>
</html>